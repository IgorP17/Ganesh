–Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –≤–∞—à –ø—Ä–æ–µ–∫—Ç –∏ –ø—Ä–µ–¥–ª–∞–≥–∞—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è headers –≤ –ë–î –∏ –ø–µ—Ä–µ–¥–∞—á–∏ –∏—Ö –≤ Kafka. –í–æ—Ç –ø–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ:
1. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è DDL –¥–ª—è app1 –∏ app2

–î–ª—è app1 (–¥–æ–±–∞–≤–∏—Ç—å –≤ ddl/app1.sql):
sql

ALTER TABLE requests ADD COLUMN headers JSONB;

–î–ª—è app2 (–¥–æ–±–∞–≤–∏—Ç—å –≤ ddl/app2.sql):
sql

ALTER TABLE processed_requests ADD COLUMN headers JSONB;

2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π

–î–ª—è app1 (Request.java):
java

@Entity
@Table(name = "requests")
public class Request {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è

    @Column(columnDefinition = "jsonb")
    private String headers; // –∏–ª–∏ Map<String, String> –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ hibernate-types

    // –ì–µ—Ç—Ç–µ—Ä—ã –∏ —Å–µ—Ç—Ç–µ—Ä—ã
}

3. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤

–í RequestController (app1):
java

@PostMapping("/send")
public ResponseEntity<String> sendRequest(
        @RequestHeader HttpHeaders headers,
        @RequestBody(required = false) String data) {

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ headers –≤ –ë–î
    Request request = new Request();
    request.setData(data);
    request.setHeaders(convertHeadersToJson(headers)); // –†–µ–∞–ª–∏–∑—É–π—Ç–µ —ç—Ç–æ—Ç –º–µ—Ç–æ–¥

    requestRepository.save(request);

    // –ü–µ—Ä–µ–¥–∞—á–∞ –≤ Kafka —Å headers
    kafkaProducerService.sendMessageWithHeaders(
        "requests",
        request.getId(),
        data,
        headers
    );

    return ResponseEntity.ok("Request saved");
}

private String convertHeadersToJson(HttpHeaders headers) {
    Map<String, String> headerMap = headers.entrySet().stream()
        .collect(Collectors.toMap(
            Map.Entry::getKey,
            e -> String.join(",", e.getValue())
        );
    return new ObjectMapper().writeValueAsString(headerMap);
}

4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Kafka Producer (KafkaProducerService.java)
java

public void sendMessageWithHeaders(
        String topic,
        Long key,
        String message,
        HttpHeaders headers) {

    ProducerRecord<String, String> record =
        new ProducerRecord<>(topic, key.toString(), message);

    // –î–æ–±–∞–≤–ª—è–µ–º headers –≤ Kafka message
    headers.forEach((name, values) ->
        record.headers().add(name, values.get(0).getBytes()));

    kafkaTemplate.send(record);
}

5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ app2

–í app2 –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:
java

@KafkaListener(topics = "requests")
public void listen(ConsumerRecord<String, String> record) {
    // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ headers –∏–∑ Kafka message
    Map<String, String> headers = new HashMap<>();
    for (Header header : record.headers()) {
        headers.put(header.key(), new String(header.value()));
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
    ProcessedRequest processedRequest = new ProcessedRequest();
    processedRequest.setOriginalData(record.value());
    processedRequest.setHeaders(new ObjectMapper().writeValueAsString(headers));

    processedRequestRepository.save(processedRequest);
}

6. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å JSON –≤ PostgreSQL –¥–æ–±–∞–≤—å—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –≤ pom.xml:
xml

<dependency>
    <groupId>com.vladmihalcea</groupId>
    <artifactId>hibernate-types-52</artifactId>
    <version>2.21.1</version>
</dependency>

–ò –∞–Ω–Ω–æ—Ç–∏—Ä—É–π—Ç–µ –ø–æ–ª–µ headers:
java

@Type(type = "jsonb")
@Column(columnDefinition = "jsonb")
private String headers;

–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã:

    –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞–ø—Ä–æ—Å —Å headers:

bash

curl -X POST -H "Content-Type: application/json" -H "X-Custom-Header: value" -d "test" http://localhost:8080/api/send

    –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î - –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è headers –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.

    –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ app2 –ø–æ–ª—É—á–∏–ª –∏ —Å–æ—Ö—Ä–∞–Ω–∏–ª headers.

–≠—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –æ–±–µ—Å–ø–µ—á–∏—Ç:

    –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö headers –≤ –ë–î

    –ü–µ—Ä–µ–¥–∞—á—É headers —á–µ—Ä–µ–∑ Kafka

    –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º

    –ü–æ–¥–¥–µ—Ä–∂–∫—É –ª—é–±—ã—Ö headers (–≤–∫–ª—é—á–∞—è –∫–∞—Å—Ç–æ–º–Ω—ã–µ)

New chat
=====================================================================================================
–í–æ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã, –∑–∞—á–µ–º –≤–∞–º –º–æ–≥–ª–æ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è —Å–æ—Ö—Ä–∞–Ω—è—Ç—å HTTP-–∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ –ë–î, –∏ –∫–∞–∫ —ç—Ç–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –¥—Ä—É–≥–∏—Ö —Ü–µ–ª–µ–π:
üîç –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è headers:

    –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–∫–∞–∫ –≤—ã –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–ª–∏)

        Content-Type - –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ (JSON/TXT/XML)

        Accept - –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ —Ç–∏–ø–∞ –æ—Ç–≤–µ—Ç–∞

    –ê–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤:

        User-Agent - –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à—ë–ª –∑–∞–ø—Ä–æ—Å (–º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ/–±—Ä–∞—É–∑–µ—Ä)

        Referer - —Å –∫–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏—à—ë–ª –∑–∞–ø—Ä–æ—Å

    –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∞—É–¥–∏—Ç:

        Authorization - –∫—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–ª –∑–∞–ø—Ä–æ—Å (–º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å —Ö—ç—à)

        X-Forwarded-For - —Ä–µ–∞–ª—å–Ω—ã–π IP –∑–∞ –ø—Ä–æ–∫—Å–∏

    –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ Kafka:

        –ü–µ—Ä–µ–¥–∞—á–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º–∏

        –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ headers

üõ† –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ –¥–ª—è –≤–∞—à–µ–≥–æ —Å–ª—É—á–∞—è:

–î–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∞ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–∫—É—é –ª–æ–≥–∏–∫—É:
java

@PostMapping("/send")
public ResponseEntity<String> sendRequest(
        @RequestHeader HttpHeaders headers,
        @RequestBody(required = false) String data) {

    // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è Content-Type
    MediaType contentType = headers.getContentType();
    if (contentType == null) {
        return ResponseEntity.badRequest().body("Missing Content-Type");
    }

    // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞
    if (contentType.includes(MediaType.APPLICATION_JSON)) {
        try {
            new ObjectMapper().readTree(data); // –í–∞–ª–∏–¥–∞—Ü–∏—è JSON
        } catch (Exception e) {
            return ResponseEntity.badRequest().body("Invalid JSON");
        }
    }
    else if (contentType.includes(MediaType.TEXT_PLAIN)) {
        if (data == null || data.length() > 1000) {
            return ResponseEntity.badRequest().body("Invalid text data");
        }
    }
    else {
        return ResponseEntity.status(HttpStatus.UNSUPPORTED_MEDIA_TYPE)
               .body("Unsupported content type");
    }

    // 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è –∞—É–¥–∏—Ç–∞
    Request request = new Request();
    request.setData(data);
    request.setContentType(contentType.toString());
    requestRepository.save(request);

    // ...
}

üìå –ß—Ç–æ —ç—Ç–æ –¥–∞—ë—Ç:

    –ì–∏–±–∫—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ headers

    –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ —Ç–∏–ø—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞

    –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º - –µ—Å–ª–∏ –ø—Ä–∏—à—ë–ª –±–∏—Ç—ã–π JSON, –≤—ã —É–≤–∏–¥–∏—Ç–µ:

        –ö–∞–∫–∏–µ headers –±—ã–ª–∏

        –ö–∞–∫–æ–µ –±—ã–ª–æ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞

        –ö–æ–≥–¥–∞ —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ

üí° –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥:

–ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑–ª–∏—á–∞—Ç—å TXT/JSON, –º–æ–∂–Ω–æ –ø—Ä–æ—â–µ:
java

if (data.startsWith("{") && data.endsWith("}")) {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∫ JSON
} else {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∫ TXT
}

–ù–æ —Ö—Ä–∞–Ω–µ–Ω–∏–µ headers –¥–∞—ë—Ç –±–æ–ª—å—à–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –æ—Ç–ª–∞–¥–∫–∏.
New chat
